<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ page.title | default: site.title }}</title>
  <meta name="description" content="{{ page.description | default: site.description }}">
  {{ site.head }}
</head>
<body>
  <header>
    <h1><a href="{{ "/" | relative_url }}">{{ site.title }}</a></h1>
    {% if site.header_pages %}
      <nav>
        <ul>
          {% for page in site.header_pages %}
            <li>
              <a href="{{ page | relative_url }}">
                {{ page | split: '/' | last | replace: '.md','' | capitalize }}
              </a>
            </li>
          {% endfor %}
        </ul>
      </nav>
    {% endif %}
  </header>

  <main>
    {{ content }}
  </main>

  <footer>
    <p>&copy; {{ site.time | date: "%Y" }} {{ site.title }}</p>
  </footer>

  {%- assign wants_mermaid = page.mermaid | default: site.mermaid | default: false -%}
  {% if wants_mermaid %}
    <!-- Mermaid v10 (non-module build works on GitHub Pages) -->
    <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
    <script>
      (function () {
        function normalizeSmart(s) {
          return (s || "")
            .replace(/[\u2018\u2019]/g, "'")   // ‘ ’ -> '
            .replace(/[\u201C\u201D]/g, '"')   // “ ” -> "
            .replace(/[\u2013\u2014]/g, '-')   // – — -> -
            .replace(/\u00A0/g, ' ');          // &nbsp; -> space
        }

        function renderMermaid() {
          if (!window.mermaid) return;

          // 1) CLEAN & MARK: wrappers produced by Jekyll/Rouge (div.language-mermaid ...)
          document.querySelectorAll('div.language-mermaid').forEach(function (el) {
            el.textContent = normalizeSmart(el.textContent); // strip inner <pre><code> wrapper to plain text
            el.classList.add('mermaid');                     // so Mermaid will render it
          });

          // 2) CONVERT: fenced blocks that survive as <pre><code class="language-mermaid">...</code></pre>
          var selectors = [
            'pre > code.language-mermaid',
            'pre > code.mermaid',
            'div.highlight pre > code.language-mermaid',
            'div.highlight pre > code.mermaid'
          ];
          document.querySelectorAll(selectors.join(', ')).forEach(function (code) {
            var pre = code.closest('pre') || code.parentElement;
            if (!pre) return;
            var div = document.createElement('div');
            div.className = 'mermaid';
            div.textContent = normalizeSmart(code.textContent);
            pre.replaceWith(div);
          });

          // 3) INIT & RUN
          var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          mermaid.initialize({
            startOnLoad: false,                 // we call run() ourselves
            securityLevel: 'strict',
            theme: prefersDark ? 'dark' : 'default'
          });
          // Render both .mermaid and any remaining .language-mermaid (after step 1 above)
          mermaid.run({ querySelector: '.mermaid, .language-mermaid' }); // v10 API
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', renderMermaid);
        } else {
          renderMermaid();
        }
      })();
    </script>
  {% endif %}
</body>
</html>
